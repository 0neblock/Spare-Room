<html>
<head>
    <title>RMIT Spare Room</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <style>
    
    </style>
    <script>
        var roomString = "";
        var room = 0;
        var level = 0;
        var building = 0;
        var levels = 11;
        var rooms = 15;
        
        $(function(){
            getRooms();
             $("#levelUL").trigger("create");
             $("#roomUL").trigger("create");
             $("#roomConfirm").trigger("create");
        });
        
        function deleteRoom(room, day, hour){
            var deleteArray = {'room': room, 'day': day, 'hour': hour};
            if(confirm("Remove this Room from 'Free' list permanently ?")){
                $.post("delete_room.php", deleteArray, function(data){
                    getRooms();
                });
            }
        }
        
        function submit(){
            var postArray = {room: roomString};
            $.post("post_room.php", postArray, function(data){
                location.href = "#main";
                getRooms();
            });
        }
        
        function getRooms(){
            $.getJSON("get_rooms.php", function(data){
                $("#current").html("");
                console.log(data);
                if(data.roomsAvailable > 0){
                    $.each(data.formatted.current, function(index, room){
                        $("#current").append("<li data-theme='a' onclick=\"deleteRoom('" + room.room + "', " + room.day + ", " + room.hour + ")\"><b>" + room.room + "</b> for " + room.hours + " hour(s)</li>");
                        $("#current").listview("refresh");
                    });
                    $("#upcoming").html("");
                    
                } else {
                    $("#current").html(data.message);
                    $("#currentText").hide();
                }
                if(data.formatted.freeFrom.length){
                        console.log("hey");
                        $.each(data.formatted.freeFrom, function(index, room){
                            $("#upcoming").append("<li data-theme='a'><b>" + room.room + "</b> is free from " + room.startTime + " until " + room.endTime + "</li>");
                            $("#upcoming").listview("refresh");
                        });
                    } else {
                        $("#upcomingText").hide();
                    }
            });
        }
        
        function clickBuilding(buildNum){
            $("#levelUL").html("");
            location.href = "#levels";
            building = buildNum;
            for(var i = 1; i <= levels; i++){
                $("#levelUL").append("<li><a href='#rooms' onclick='clickLevel($(this).html())'>" + i + "</a></li>");
                
            }
            $("#levelUL").trigger("create");
            $("#levelUL").listview("refresh");
        }
        
        function clickLevel(levelNum){
            $("#roomUL").html("");
            location.href = "#rooms";
            level = levelNum;
            roomString += "." + level.toString();
            for(var i = 1; i <= rooms; i++){
                $("#roomUL").append("<li><a onclick='clickRoom($(this).html())'>" + i + "</a></li>");
            }
            $("#roomUL").trigger("create");
            $("#roomUL").listview("refresh");
        }
        
        function clickRoom(roomNum){
            room = roomNum;
            roomString = building.toString() + "." + level.toString() + "." + room.toString();
            console.log(roomString);
            $("#roomConfirm").html("");
            location.href = "#confirm";
            $("#roomConfirm").append("<li>Room " + roomString + " is Free right now</li><br /><li><a href='#' onclick='submit();'>Confirm?</a></li>");
            $("#roomConfirm").trigger("create");
            $("#roomConfirm").listview("refresh");;
        }
    </script>
    </head>
    <body>
        <div data-role="page" id="main"> 
            <div data-role="header">
                <h1>RMIT Room Hunter</h1>
            </div>
            <div data-role="content" >
                <div data-role="controlgroup" >
                   <span id="currentText"> Current:</span>
                <ul data-role="listview" id="current" data-inset="true"></ul>
                    <span id="upcomingText" >Upcoming: </span>
                <ul data-role="listview" id="upcoming" data-inset="true"></ul>
                    
                    Add Free Room:
                <ul data-role="listview" id="buildingPicker" data-inset="true"><li><a data-icon="forward" onClick='clickBuilding($(this).html())'>80</a></li></ul>
            </div>
            </div> 
        </div> 
        <div data-role="page" id="levels"> 
            <div data-role="content">
                <a class="ui-btn ui-btn-inline" href="#main" data-inline="true" >Back</a>
                <b>Select Level:</b>
                <ul data-role="listview" id="levelUL" data-inset="true"></ul>
            </div> 
        </div> 
        <div data-role="page" id="rooms"> 
            <div data-role="content">
                <a class="ui-btn ui-btn-inline" href="#levels" data-inline="true" >Back</a>
                <b>Select Room:</b>
                <ul data-role="listview" id="roomUL" data-inset="true"></ul>
            </div> 
        </div> 
        <div data-role="page" id="confirm"> 
            <div data-role="content" >
                <a class="ui-btn ui-btn-inline" href="#main" data-inline="true" >Home</a>
                <a class="ui-btn ui-btn-inline" data-inline="true" href="#rooms" >Back</a>
                <ul data-role="listview" id="roomConfirm" data-inset="true">
                    
                </ul>
            </div> 
        </div> 
    </body>
</html>